<p-card [header]="getFormTitle()" styleClass="form-card">
  <form [formGroup]="groupForm" (ngSubmit)="onSubmit()">
    <!-- Group Name Field -->
    <div class="form-field">
      <p-floatlabel>
        <label for="name" class="field-label">Group Name</label>
        <input
          id="name"
          type="text"
          class="line-border"
          pInputText
          formControlName="name"
          [readonly]="mode() === 'view'"
          placeholder="Enter group name"
        />
      </p-floatlabel>
      @if (isFieldInvalid('name')) {
        <small class="p-error block mt-1">Group name is required</small>
      }
    </div>

    <!-- Description Field -->
    <div class="form-field">
      <p-floatlabel>
        <label for="description" class="field-label">Description</label>
        <textarea
          id="description"
          pInputTextarea
          formControlName="description"
          [readonly]="mode() === 'view'"
          placeholder="Enter group description (optional)"
          rows="3"
          class="line-border">
        </textarea>
      </p-floatlabel>
    </div>

    <!-- Max Members Field -->
    <div class="form-field">
      <p-floatlabel>
        <label for="maxMembers" class="field-label">Maximum Members</label>
        <p-inputNumber
          id="maxMembers"
          formControlName="maxMembers"
          [readonly]="mode() === 'view'"
          [min]="1"
          [max]="50"
          placeholder="Maximum number of members"
          styleClass="line-border">
        </p-inputNumber>
      </p-floatlabel>
      @if (isFieldInvalid('maxMembers')) {
        <small class="p-error block mt-1">Please enter a valid number between 1 and 50</small>
      }
    </div>

    <!-- Location Field -->
    <div class="form-field">
      <label class="field-label">Location</label>
      
      <!-- Location Mode Switcher (only for create/edit modes) -->
      @if (mode() !== 'view') {
        <div class="mb-3">
          <div class="flex gap-2">
            <p-button
              type="button"
              label="Get Location"
              icon="pi pi-map-marker"
              [severity]="locationMode() === 'auto' ? 'primary' : 'secondary'"
              [outlined]="locationMode() !== 'auto'"
              size="small"
              (onClick)="setLocationMode('auto')"
            />
            <p-button
              type="button"
              label="Manual Entry"
              icon="pi pi-pencil"
              [severity]="locationMode() === 'manual' ? 'primary' : 'secondary'"
              [outlined]="locationMode() !== 'manual'"
              size="small"
              (onClick)="setLocationMode('manual')"
            />
          </div>
        </div>
      }
      
      <!-- Location Display/Input -->
      <div class="flex flex-col gap-8">
        <!-- Current Location Display -->
        @if (groupForm.get('latitude')?.value && groupForm.get('longitude')?.value) {
          <div class="bg-green-50 p-3 rounded-md border border-green-200">
            <div class="flex items-center gap-2">
              <i class="pi pi-map-marker text-green-600"></i>
              <span class="text-sm text-green-700">{{ getLocationString() }}</span>
            </div>
          </div>
        } @else {
          <div class="bg-gray-50 p-3 rounded-md border border-gray-200">
            <div class="flex items-center gap-2">
              <i class="pi pi-map-marker text-gray-400"></i>
              <span class="text-sm text-gray-500">No location set</span>
            </div>
          </div>
        }

        <!-- Location Error -->
        @if (locationError()) {
          <div class="bg-red-50 p-3 rounded-md border border-red-200">
            <div class="flex items-center gap-2">
              <i class="pi pi-exclamation-triangle text-red-600"></i>
              <span class="text-sm text-red-700">{{ locationError() }}</span>
            </div>
          </div>
        }

        <!-- Auto Location Actions -->
        @if (mode() !== 'view' && locationMode() === 'auto') {
          <div class="flex flex-wrap gap-2">
            <p-button
              type="button"
              label="Get Current Location"
              icon="pi pi-map-marker"
              [loading]="isGettingLocation()"
              severity="success"
              size="small"
              (onClick)="getCurrentLocation()"
            />
            
            @if (groupForm.get('latitude')?.value || groupForm.get('longitude')?.value) {
              <p-button
                type="button"
                label="Clear Location"
                icon="pi pi-times"
                severity="secondary"
                size="small"
                outlined
                (onClick)="clearLocation()"
              />
            }
          </div>
        }

        <!-- Manual Coordinate Input -->
        @if (mode() !== 'view' && locationMode() === 'manual') {
          <div class="space-y-3">
            <div class="grid grid-cols-2 gap-3">
              <div style="position: relative;">
                <p-floatlabel>
                  <input
                    pInputText
                    id="latitude"
                    formControlName="latitude"
                    type="number"
                    step="any"
                    min="-90"
                    max="90"
                    placeholder="e.g., 37.7749"
                    class="line-border"
                  />
                  <label for="latitude">Latitude (-90 to 90)</label>
                </p-floatlabel>
                @if (isFieldInvalid('latitude')) {
                  @if (groupForm.get('latitude')?.hasError('required')) {
                    <small class="p-error block mt-1">Latitude is required</small>
                  } @else {
                    <small class="p-error block mt-1">Latitude must be between -90 and 90</small>
                  }
                }
              </div>

              <div style="position: relative;">
                <p-floatlabel>
                  <input
                    pInputText
                    id="longitude"
                    formControlName="longitude"
                    type="number"
                    step="any"
                    min="-180"
                    max="180"
                    placeholder="e.g., -122.4194"
                    class="line-border"
                  />
                  <label for="longitude">Longitude (-180 to 180)</label>
                </p-floatlabel>
                @if (isFieldInvalid('longitude')) {
                  @if (groupForm.get('longitude')?.hasError('required')) {
                    <small class="p-error block mt-1">Longitude is required</small>
                  } @else {
                    <small class="p-error block mt-1">Longitude must be between -180 and 180</small>
                  }
                }
              </div>
            </div>
          </div>
        }
      </div>
    </div>

    <!-- Active Status Field (only for edit mode) -->
    @if (mode() === 'edit') {
      <div class="form-field">
        <label class="field-label">Group Status</label>
        <p-toggleButton 
          formControlName="isActive" 
          onLabel="Active" 
          offLabel="Inactive">
        </p-toggleButton>
      </div>
    }

    <!-- Action Buttons -->
    <div class="form-actions">
      @if (mode() !== 'view') {
        <p-button
          type="submit"
          [label]="mode() === 'create' ? 'Create Group' : 'Update Group'"
          [loading]="isLoading()"
          [disabled]="groupForm.invalid"
          styleClass="w-full">
        </p-button>
      }
      
      <p-button
        type="button"
        [label]="mode() === 'view' ? 'Close' : 'Cancel'"
        severity="secondary"
        styleClass="w-full"
        (click)="onCancel()">
      </p-button>
    </div>
  </form>
</p-card>